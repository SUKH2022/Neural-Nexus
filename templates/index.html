<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neural Nexus | AI Strategy Game</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ§ </text></svg>">
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">NEURAL NEXUS</div>
            <div class="score">SCORE: <span id="score-value">0</span></div>
        </header>
        
        <div class="game-container">
            <div class="game-board" id="game-board">
                <!-- Cells will be generated by JavaScript -->
            </div>
            
            <div class="sidebar">
                <div class="status">
                    <h2>GAME STATUS</h2>
                    <p id="status-message">Place your first move to begin</p>
                    <p id="debug-info" style="color: #ff4444; font-size: 12px;"></p>
                </div>
                
                <div class="difficulty-selector">
                    <label for="difficulty">AI DIFFICULTY:</label>
                    <select id="difficulty">
                        <option value="easy">NOVICE</option>
                        <option value="medium">ADEPT</option>
                        <option value="hard">MASTER</option>
                        <option value="impossible">NEURAL NETWORK</option>
                    </select>
                </div>
                
                <div class="ai-thinking">
                    <h2>AI THOUGHTS</h2>
                    <p id="ai-thought">Waiting for your move...</p>
                </div>
                
                <button class="btn" id="restart-btn">NEW GAME</button>
                <button class="btn" id="debug-btn" style="background: #ff4444;">DEBUG CONNECTION</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const gameBoard = document.getElementById('game-board');
            const statusMessage = document.getElementById('status-message');
            const aiThought = document.getElementById('ai-thought');
            const restartBtn = document.getElementById('restart-btn');
            const debugBtn = document.getElementById('debug-btn');
            const debugInfo = document.getElementById('debug-info');
            const difficultySelect = document.getElementById('difficulty');
            const scoreValue = document.getElementById('score-value');
            
            let board = [];
            let currentPlayer = 'player';
            let gameActive = true;
            let score = 0;
            let aiThinking = false;
            
            // Test API connection
            debugBtn.addEventListener('click', function() {
                debugInfo.textContent = "Testing API connection...";
                
                // Test the API endpoint
                fetch('/ai_move', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        board: Array(8).fill().map(() => Array(8).fill(0)),
                        difficulty: 'easy'
                    })
                })
                .then(response => {
                    debugInfo.textContent = `API responded with status: ${response.status}`;
                    return response.json();
                })
                .then(data => {
                    debugInfo.textContent += ` | Response: ${JSON.stringify(data)}`;
                    console.log("API test response:", data);
                })
                .catch(error => {
                    debugInfo.textContent = `API Error: ${error}`;
                    console.error("API test error:", error);
                });
            });
            
            // Initialize game board
            function initBoard() {
                gameBoard.innerHTML = '';
                board = Array(8).fill().map(() => Array(8).fill(0));
                
                for (let i = 0; i < 8; i++) {
                    for (let j = 0; j < 8; j++) {
                        const cell = document.createElement('div');
                        cell.classList.add('cell');
                        cell.dataset.row = i;
                        cell.dataset.col = j;
                        cell.addEventListener('click', () => cellClicked(i, j));
                        gameBoard.appendChild(cell);
                    }
                }
                
                // Set initial pieces
                board[3][3] = 1; // 1 represents player
                board[3][4] = 2; // 2 represents AI
                board[4][3] = 2;
                board[4][4] = 1;
                
                updateBoard();
                updateStatus();
            }
            
            // Update visual board
            function updateBoard() {
                const cells = document.querySelectorAll('.cell');
                cells.forEach(cell => {
                    const row = parseInt(cell.dataset.row);
                    const col = parseInt(cell.dataset.col);
                    
                    cell.className = 'cell';
                    if (board[row][col] === 1) {
                        cell.classList.add('player');
                    } else if (board[row][col] === 2) {
                        cell.classList.add('ai');
                    }
                });
            }
            
            // Handle cell click
            function cellClicked(row, col) {
                console.log(`Cell clicked: ${row}, ${col}, value: ${board[row][col]}`);
                
                if (!gameActive) {
                    console.log("Game not active");
                    return;
                }
                
                if (aiThinking) {
                    console.log("AI is thinking, please wait");
                    return;
                }
                
                if (board[row][col] !== 0) {
                    console.log("Cell already occupied");
                    return;
                }
                
                if (isValidMove(row, col, 1)) {
                    console.log("Move is valid, making move");
                    makeMove(row, col, 1);
                    updateBoard();
                    
                    if (checkGameOver()) {
                        endGame();
                        return;
                    }
                    
                    currentPlayer = 'ai';
                    updateStatus();
                    aiThinking = true;
                    aiThought.textContent = "Analyzing your strategy...";
                    
                    // Call the AI backend
                    fetch('/ai_move', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            board: board,
                            difficulty: difficultySelect.value
                        })
                    })
                    .then(response => {
                        console.log("API response status:", response.status);
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log("API response data:", data);
                        
                        if (data.error) {
                            console.error('AI error:', data.error);
                            aiThinking = false;
                            currentPlayer = 'player';
                            updateStatus();
                            aiThought.textContent = "AI error: " + data.error;
                            return;
                        }
                        
                        makeMove(data.row, data.col, 2);
                        aiThinking = false;
                        updateBoard();
                        
                        if (checkGameOver()) {
                            endGame();
                            return;
                        }
                        
                        currentPlayer = 'player';
                        updateStatus();
                        aiThought.textContent = getAIThought(difficultySelect.value);
                    })
                    .catch(error => {
                        console.error('Error calling AI:', error);
                        aiThinking = false;
                        currentPlayer = 'player';
                        updateStatus();
                        aiThought.textContent = "Connection error. Try again.";
                        debugInfo.textContent = `Error: ${error.message}`;
                    });
                } else {
                    console.log("Move is not valid");
                    statusMessage.textContent = "Invalid move! Try another position.";
                    setTimeout(() => updateStatus(), 1500);
                }
            }
            
            // Get a random AI thought based on difficulty
            function getAIThought(difficulty) {
                const thoughts = {
                    easy: [
                        "Let's try this move...",
                        "Hmm, interesting strategy...",
                        "I'm still learning!",
                        "You're pretty good at this!"
                    ],
                    medium: [
                        "I see your strategy developing...",
                        "You've fallen into my trap!",
                        "This is getting interesting...",
                        "I'm adapting to your play style."
                    ],
                    hard: [
                        "Your patterns are becoming predictable...",
                        "I've calculated 42 possible outcomes...",
                        "You're making this too easy...",
                        "My algorithms are learning from you."
                    ],
                    impossible: [
                        "My neural network predicts your defeat in 7 moves.",
                        "I've analyzed 10,000 possible scenarios in nanoseconds.",
                        "You're playing against a superior intelligence.",
                        "Resistance is futile."
                    ]
                };
                
                const difficultyThoughts = thoughts[difficulty] || thoughts.easy;
                return difficultyThoughts[Math.floor(Math.random() * difficultyThoughts.length)];
            }
            
            // Check if move is valid
            function isValidMove(row, col, player) {
                // Check if the cell is empty
                if (board[row][col] !== 0) return false;
                
                // Check if adjacent to existing pieces
                const directions = [
                    [-1, -1], [-1, 0], [-1, 1],
                    [0, -1],           [0, 1],
                    [1, -1],  [1, 0],  [1, 1]
                ];
                
                for (const [dx, dy] of directions) {
                    const newRow = row + dx;
                    const newCol = col + dy;
                    
                    if (newRow >= 0 && newRow < 8 && newCol >= 0 && newCol < 8) {
                        if (board[newRow][newCol] !== 0 && board[newRow][newCol] !== player) {
                            return true;
                        }
                    }
                }
                
                return false;
            }
            
            // Make a move
            function makeMove(row, col, player) {
                board[row][col] = player;
                
                // Flip opponent's pieces (simplified)
                const directions = [
                    [-1, -1], [-1, 0], [-1, 1],
                    [0, -1],           [0, 1],
                    [1, -1],  [1, 0],  [1, 1]
                ];
                
                for (const [dx, dy] of directions) {
                    let currentRow = row + dx;
                    let currentCol = col + dy;
                    let toFlip = [];
                    
                    while (currentRow >= 0 && currentRow < 8 && currentCol >= 0 && currentCol < 8) {
                        if (board[currentRow][currentCol] === 0) break;
                        
                        if (board[currentRow][currentCol] !== player) {
                            toFlip.push([currentRow, currentCol]);
                        } else {
                            // Flip all pieces in between
                            for (const [flipRow, flipCol] of toFlip) {
                                board[flipRow][flipCol] = player;
                            }
                            break;
                        }
                        
                        currentRow += dx;
                        currentCol += dy;
                    }
                }
            }
            
            // Check if game is over
            function checkGameOver() {
                // Check if board is full
                for (let i = 0; i < 8; i++) {
                    for (let j = 0; j < 8; j++) {
                        if (board[i][j] === 0) {
                            // Check if any player can move
                            if (hasValidMoves(1) || hasValidMoves(2)) {
                                return false;
                            }
                        }
                    }
                }
                return true;
            }
            
            // Check if a player has valid moves
            function hasValidMoves(player) {
                for (let i = 0; i < 8; i++) {
                    for (let j = 0; j < 8; j++) {
                        if (board[i][j] === 0 && isValidMove(i, j, player)) {
                            return true;
                        }
                    }
                }
                return false;
            }
            
            // End the game
            function endGame() {
                gameActive = false;
                
                // Count pieces
                let playerCount = 0;
                let aiCount = 0;
                
                for (let i = 0; i < 8; i++) {
                    for (let j = 0; j < 8; j++) {
                        if (board[i][j] === 1) playerCount++;
                        if (board[i][j] === 2) aiCount++;
                    }
                }
                
                if (playerCount > aiCount) {
                    statusMessage.textContent = "You win!";
                    score += 10;
                } else if (aiCount > playerCount) {
                    statusMessage.textContent = "AI wins!";
                } else {
                    statusMessage.textContent = "It's a tie!";
                    score += 5;
                }
                
                scoreValue.textContent = score;
            }
            
            // Update status message
            function updateStatus() {
                statusMessage.textContent = currentPlayer === 'player' 
                    ? "Your turn" 
                    : "AI is thinking...";
            }
            
            // Restart game
            restartBtn.addEventListener('click', function() {
                gameActive = true;
                currentPlayer = 'player';
                initBoard();
                aiThought.textContent = "New game initialized. Let's see what you've got.";
                debugInfo.textContent = "";
            });
            
            // Initialize the game
            initBoard();
        });
    </script>
</body>
</html>